<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soil Saturation - Armazém 25</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #1a508b; font-size: 1.5rem; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #eef2f7; padding: 15px; border-radius: 8px; flex: 1; text-align: center; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; }
        .controls { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 0.9rem; color: #333; }
        .control-group input { width: 60px; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        .control-group select { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        .control-group button { padding: 6px 15px; background: #1a508b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .control-group button:hover { background: #16437a; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="page-title">Soil Saturation Tracker: Armazém 25</h1>
    
    <div class="controls">
        <div class="control-group">
            <label for="locationSelect">Location:</label>
            <select id="locationSelect" onchange="onLocationChange()">
                <option value="armazem25">Armazém 25</option>
                <option value="montedamina">Monte da Mina</option>
                <option value="therocks">The Rocks</option>
                <option value="cercal">Cercal</option>
            </select>
        </div>
        <div class="control-group">
            <label for="pastDays">Past Days:</label>
            <input type="number" id="pastDays" value="7" min="0" max="92">
        </div>
        <div class="control-group">
            <label for="futureDays">Future Days:</label>
            <input type="number" id="futureDays" value="14" min="1" max="16">
        </div>
        <div class="control-group">
            <button onclick="updateDashboard()">Update</button>
        </div>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <div class="stat-label">Current Saturation</div>
            <div id="current-sat" class="stat-value">-- %</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Rain (<span id="total-days-label">21</span>d)</div>
            <div id="total-rain" class="stat-value">-- mm</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Temp Range (<span id="temp-days-label">21</span>d)</div>
            <div id="temp-range" class="stat-value">--°C / --°C</div>
        </div>
    </div>

    <canvas id="weatherChart"></canvas>
    
    <p style="font-size: 0.8rem; color: #999; margin-top: 20px;">
        *Simulation assumes a 120mm soil water capacity. 
        Data source: Open-Meteo (GPS: <span id="coords-display">38.839361, -8.451498</span>). Adjustable date range.<br>
        Version: 1.3.0 | Last updated: 2026-02-14
    </p>
</div>

<script>
let weatherChart = null;

const locations = {
    armazem25: {
        name: 'Armazém 25',
        latitude: 38.839361,
        longitude: -8.451498
    },
    montedamina: {
        name: 'Monte da Mina',
        latitude: 38.4930,
        longitude: -8.3512
    },
    therocks: {
        name: 'The Rocks',
        latitude: 39.495524,
        longitude: -8.754372
    },
    cercal: {
        name: 'Cercal',
        latitude: 37.8347,
        longitude: -8.5613
    }
};

// Cookie helper functions
function setCookie(name, value, days) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/; SameSite=Lax';
}

function getCookie(name) {
    const value = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return value ? decodeURIComponent(value.split('=')[1]) : null;
}

function onLocationChange() {
    const locationKey = document.getElementById('locationSelect').value;
    setCookie('selectedLocation', locationKey, 365);
    updateDashboard();
}

async function updateDashboard() {
    const locationKey = document.getElementById('locationSelect').value;
    const location = locations[locationKey];
    const pastDays = parseInt(document.getElementById('pastDays').value) || 7;
    const futureDays = parseInt(document.getElementById('futureDays').value) || 14;
    const totalDays = pastDays + futureDays;
    
    // Update title and coordinates display
    document.getElementById('page-title').innerText = `Soil Saturation Tracker: ${location.name}`;
    document.title = `Soil Saturation - ${location.name}`;
    document.getElementById('coords-display').innerText = `${location.latitude}, ${location.longitude}`;
    
    // Update labels
    document.getElementById('total-days-label').innerText = totalDays;
    document.getElementById('temp-days-label').innerText = totalDays;
    
    // Use maximum past days (92) to calculate a better starting saturation
    const maxPastDays = 92;
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${location.latitude}&longitude=${location.longitude}&daily=precipitation_sum,et0_fao_evapotranspiration,temperature_2m_max,temperature_2m_min&past_days=${maxPastDays}&forecast_days=${futureDays}&timezone=Europe%2FLisbon`;
    
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
        }
        const data = await response.json();
        if (!data.daily) {
            throw new Error('Invalid API response: missing daily data');
        }
        const daily = data.daily;

        // Simulation Parameters
        const MAX_CAPACITY = 120; // mm
        let currentStorage = 40;   // Estimated starting point (assumption for 92 days prior)
        let saturationHistory = [];
        let totalRain = 0;

        // Calculate Saturation over the full period (including pre-display days for accurate starting saturation)
        // The number of pre-display days used to calculate initial saturation
        const preDisplayDays = Math.max(0, maxPastDays - pastDays);
        
        for (let i = 0; i < daily.time.length; i++) {
            const rain = daily.precipitation_sum[i];
            const et0 = daily.et0_fao_evapotranspiration[i];
            
            currentStorage = currentStorage + rain - et0;
            
            // Constraints
            if (currentStorage > MAX_CAPACITY) currentStorage = MAX_CAPACITY;
            if (currentStorage < 0) currentStorage = 0;
            
            const satPct = (currentStorage / MAX_CAPACITY) * 100;
            saturationHistory.push(satPct.toFixed(1));
            
            // Only count rain for the display period
            if (i >= preDisplayDays) {
                totalRain += rain;
            }
        }
        
        // Extract only the display period data (last pastDays + futureDays entries)
        const displayDates = daily.time.slice(preDisplayDays);
        const displaySaturation = saturationHistory.slice(preDisplayDays);
        const displayTempMax = daily.temperature_2m_max.slice(preDisplayDays);
        const displayTempMin = daily.temperature_2m_min.slice(preDisplayDays);
        const displayPrecip = daily.precipitation_sum.slice(preDisplayDays);
        const displayET0 = daily.et0_fao_evapotranspiration.slice(preDisplayDays);

        // Update UI Cards - use pastDays as the index for "current" saturation (today)
        const currentIndex = Math.min(pastDays, displaySaturation.length - 1);
        document.getElementById('current-sat').innerText = displaySaturation[currentIndex] + "%";
        document.getElementById('total-rain').innerText = totalRain.toFixed(1) + " mm";
        
        // Calculate min and max temperatures over the display period
        const validMaxTemps = displayTempMax.filter(t => t !== null);
        const validMinTemps = displayTempMin.filter(t => t !== null);
        const overallMax = validMaxTemps.length > 0 ? Math.max(...validMaxTemps).toFixed(1) : "--";
        const overallMin = validMinTemps.length > 0 ? Math.min(...validMinTemps).toFixed(1) : "--";
        document.getElementById('temp-range').innerText = overallMin + "°C / " + overallMax + "°C";

        // Prepare stacked bar data: rainfall minus evapotranspiration (net water) at bottom, evapotranspiration on top
        // Total bar height = total rainfall
        const netWater = [];
        const et0ForStack = [];
        for (let i = 0; i < displayDates.length; i++) {
            const rain = displayPrecip[i] || 0;
            const et0 = displayET0[i] || 0;
            // Net water (rainfall - evapotranspiration), can be negative
            const net = rain - et0;
            if (net >= 0) {
                netWater.push(net);
                et0ForStack.push(et0);
            } else {
                // When ET exceeds rain, show ET taking up full rain amount and net as negative
                netWater.push(net);
                et0ForStack.push(rain);
            }
        }

        // Destroy existing chart if it exists
        if (weatherChart) {
            weatherChart.destroy();
        }

        // Create Combined Chart
        const ctx = document.getElementById('weatherChart').getContext('2d');
        
        weatherChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: displayDates,
                datasets: [
                    {
                        label: 'Soil Saturation (%)',
                        data: displaySaturation,
                        type: 'line',
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.3)',
                        fill: true,
                        yAxisID: 'y2',
                        tension: 0.3,
                        spanGaps: true,
                        order: 0
                    },
                    {
                        label: 'Net Water (Rain - ET)',
                        data: netWater,
                        backgroundColor: '#3498db',
                        yAxisID: 'y',
                        borderRadius: 4,
                        stack: 'rainfall'
                    },
                    {
                        label: 'Evapotranspiration (mm)',
                        data: et0ForStack,
                        backgroundColor: '#e74c3c',
                        yAxisID: 'y',
                        borderRadius: 4,
                        stack: 'rainfall'
                    },
                    {
                        label: 'Max Temp (°C)',
                        data: displayTempMax,
                        type: 'line',
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        fill: false,
                        yAxisID: 'y1',
                        tension: 0.3,
                        spanGaps: true,
                        order: 2
                    },
                    {
                        label: 'Min Temp (°C)',
                        data: displayTempMin,
                        type: 'line',
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        fill: false,
                        yAxisID: 'y1',
                        tension: 0.3,
                        spanGaps: true,
                        order: 1
                    }
                ]
            },
            options: {
                scales: {
                    x: {
                        stacked: true
                    },
                    y: { 
                        stacked: true,
                        title: { display: true, text: 'Rain / ET (mm)' }, 
                        position: 'left'
                    },
                    y1: { 
                        title: { display: true, text: 'Temperature (°C)' }, 
                        position: 'right', 
                        grid: { drawOnChartArea: false }
                    },
                    y2: {
                        title: { display: true, text: 'Saturation (%)' },
                        position: 'right',
                        min: 0,
                        max: 100,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

    } catch (error) {
        console.error("Error fetching data:", error);
    }
}

// Initialize with saved location from cookie or default to armazem25
function initializePage() {
    const savedLocation = getCookie('selectedLocation');
    const locationSelect = document.getElementById('locationSelect');
    
    if (savedLocation && locations[savedLocation]) {
        locationSelect.value = savedLocation;
    } else {
        locationSelect.value = 'armazem25';
    }
    
    updateDashboard();
}

initializePage();
</script>
</body>
</html>
