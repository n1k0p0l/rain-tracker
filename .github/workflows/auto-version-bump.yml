name: Auto Version Bump

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  bump-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          
      - name: Extract current version and bump
        id: version
        run: |
          # Extract current version from index.html line 77
          CURRENT_LINE=$(sed -n '77p' index.html)
          echo "Current line: $CURRENT_LINE"
          
          # Extract version using regex
          CURRENT_VERSION=$(echo "$CURRENT_LINE" | grep -oP 'Version: \K[0-9]+\.[0-9]+\.[0-9]+')
          echo "Current version: $CURRENT_VERSION"
          
          if [ -z "$CURRENT_VERSION" ]; then
            echo "Error: Could not extract version from index.html"
            exit 1
          fi
          
          # Split version into components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          # Determine bump type based on PR labels
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          echo "PR Labels: $LABELS"
          
          # Check for major or minor labels
          if echo "$LABELS" | grep -q '"major"'; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="major"
          elif echo "$LABELS" | grep -q '"minor"'; then
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="minor"
          else
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          fi
          
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION (${BUMP_TYPE} bump)"
          
          # Get current date in YYYY-MM-DD format
          CURRENT_DATE=$(date +%Y-%m-%d)
          echo "Current date: $CURRENT_DATE"
          
          # Export variables for next steps
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          
      - name: Update version in index.html
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          CURRENT_DATE="${{ steps.version.outputs.current_date }}"
          
          # Update line 77 with new version and date
          sed -i "77s#Version: [0-9]\+\.[0-9]\+\.[0-9]\+ | Last updated: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}#Version: $NEW_VERSION | Last updated: $CURRENT_DATE#" index.html
          
          echo "Updated index.html:"
          sed -n '77p' index.html
          
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add index.html
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }} after PR #${{ github.event.pull_request.number }}"
          git push origin main
